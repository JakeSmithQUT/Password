<!DOCTYPE html>
<!-- FYI must be serverd via HTTPS to function properly -->
<html>
<head>
  <!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">

<!-- jQuery library -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

<!-- Latest compiled JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>
<script src="password.js"></script>

<script src="./script/Mellt.js"></script>
<script src="./script/passgen.js"></script>
<!-- Make sure common-passwords.js is included AFTER Mellt.js -->
<script src="./script/common-passwords.js"></script>
<script>
var mellt = new Mellt();
document.getElementById("msg").innerHTML = "0 days";
document.getElementById("msg").style.color = "red";

function StrengthCheck(password) {
  runCheck();
  PassGen();
  var daysToCrack = mellt.CheckPassword(password);
  if (daysToCrack < 30){  
    document.getElementById("msg").innerHTML = daysToCrack+" days";
    document.getElementById("msg").style.color = "red";
  }else if(daysToCrack < 365){
    daysToCrack = daysToCrack/30.0;
    document.getElementById("msg").innerHTML = Math.round(daysToCrack * 100) / 100    +" months";
    document.getElementById("msg").style.color = "orange";
  } else if (daysToCrack > 2739726){
    document.getElementById("msg").innerHTML = "Heat death of the Universe";
    document.getElementById("msg").style.color = "green";
  } else {
    daysToCrack = daysToCrack/365.0;
    document.getElementById("msg").innerHTML = Math.round(daysToCrack * 100) / 100+" years";
    document.getElementById("msg").style.color = "green";
  }
}

</script>


<meta charset='UTF-8'/>
  <title>Wiley Password API lookup.</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0,  minimum-scale=1.0">  

</style>
</head>
<body>
    <br><br><br><br><br>
  <center>
    <h1>Password Check</h1>
<div id="bodyDiv" style="width:25%;">
  <center>
<input id="inPut" onkeyup="StrengthCheck(this.value);" class="form-control" type="password" placeholder="Password...">
<p>Time to break: <span id="msg"></span></p>
</center>
<div>   
  <p id="outPut"></p>
  <p id="outPut2">hello</p>
</div>

</div>
</center>
  <script>
let first = "";
let last = "";
let hash = "";
function hexString(buffer) {
  // creates an array of 8-bit unsigned integers
  const byteArray = new Uint8Array(buffer);
  // turns that hash into hex
  const hexCodes = [...byteArray].map(value => {
    // eash element in array is converted to base 16 string
    const hexCode = value.toString(16);
    // pad beggining with 0  why?
    const paddedHexCode = hexCode.padStart(2, '0');
    // return upper case hex hash
    return paddedHexCode.toUpperCase();
  });
  // return a string not an array
  return hexCodes.join('');
}

function digestMessage(message) {
   // Returns a newly constructed TextEncoder that will generate a byte stream with utf-8 encoding.
  const encoder = new TextEncoder(); 
   // Takes a USVString as input, and returns a Uint8Array containing utf-8 encoded text.
  const data = encoder.encode(message);
   // returns the hash
   //The digest() method of the SubtleCrypto interface generates a digest of the given data. 
   // A digest is a short fixed-length value derived from some variable-length input.
  return window.crypto.subtle.digest('SHA-1', data);
}

function runCheck() {
let outPut = document.getElementById("outPut");
let inPut = document.getElementById("inPut");
let text = inPut.value;
if (text === "") return false;
//inPut.value = "";

  
digestMessage(text).then(digestValue => {
  hash = hexString(digestValue);
  first = hash.substring(0, 5);
  last = hash.substring(5);
  fetch('https://api.pwnedpasswords.com/range/' + first)
  .then(
    function(response) {
      if (response.status !== 200) {
        console.log('Looks like there was a problem. Status Code: ' +
          response.status);
        return;
      }
    return response.text();
  })
  .then(function(text) {
    return text.split("\r\n");  
  })
  .then(function(arr){
    document.getElementById("outPut")
          .innerHTML = //"The password : " + text + 
          "SHA1 Hash : " + hash + 
          "<br>This password was not found!";
   
     arr.forEach((s)=>{
      
       let a = s.split(":");
       
       if(a[0] == last) {
        document.getElementById("msg").innerHTML = "Less than a second.";
        document.getElementById("msg").style.color = "red";
        
        document.getElementById("outPut")
           .innerHTML = //"The password : " + text + 
           "SHA1 Hash : <span id='hash'>" + hash + 
           "</span><br>This password was found <b>" + a[1] + "</b> times!";
           
        return true;
        
       }
      
     });
     
  })
  .catch(function(error) {
    log('Request failed', error)
  });

});
  
outPut.value = "";
  
}

document.querySelector("button")
        .addEventListener("click", runCheck);

  </script>
</body>
</html>

